{% extends 'account.html' %}
{% load static i18n %}

{% block body_attribute %}
class="dashboard"
{% endblock body_attribute %}

{% block page_content %}
<!-- Main content START -->
<div class="col-lg-8 col-xl-9">
  <!-- Offcanvas menu button -->
  <div class="d-grid mb-0 d-lg-none w-100">
    <button class="btn btn-primary mb-4" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasSidebar"
            aria-controls="offcanvasSidebar">
      <i class="fas fa-sliders-h"></i> Menu
    </button>
  </div>

  <div class="vstack gap-4">
    <!-- Messages -->
    {% if messages %}
    <ul class="list-unstyled">
      {% for message in messages %}
      <li class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </li>
      {% endfor %}
    </ul>
    {% endif %}

    <!-- Verified message -->
    <div class="bg-light rounded p-3">
      <!-- Progress bar -->
      <div class="overflow-hidden">
        <h6>Complétez votre profil</h6>
        <div class="progress progress-sm bg-success bg-opacity-10">
          <div class="progress-bar bg-success aos" role="progressbar" data-aos="slide-right"
               data-aos-delay="200" data-aos-duration="1000" data-aos-easing="ease-in-out"
               style="width: {{ profile_completion }}%"
               aria-valuenow="{{ profile_completion }}" aria-valuemin="0" aria-valuemax="100">
            <span class="progress-percent-simple h6 fw-light ms-auto">{{ profile_completion }}%</span>
          </div>
        </div>
        <p class="mb-0">Optimisez votre expérience en ajoutant les informations manquantes !</p>
      </div>
      <!-- Content -->
      <div class="bg-body rounded p-3 mt-3">
        <ul class="list-inline hstack flex-wrap gap-2 justify-content-between mb-0">
          <li class="list-inline-item h6 fw-normal mb-0">
            {% if user.email %}
            <a href="#"><i class="bi bi-check-circle-fill text-success me-2"></i>Email vérifié</a>
            {% else %}
            <a href="#update-email" class="text-primary"><i class="bi bi-plus-circle-fill me-2"></i>Ajouter un email</a>
            {% endif %}
          </li>
          <li class="list-inline-item h6 fw-normal mb-0">
            {% if traveler.phone_number %}
            <a href="#"><i class="bi bi-check-circle-fill text-success me-2"></i>Numéro de téléphone vérifié</a>
            {% else %}
            <a href="#personal-info" class="text-primary"><i class="bi bi-plus-circle-fill me-2"></i>Ajouter un numéro de téléphone</a>
            {% endif %}
          </li>
          <li class="list-inline-item h6 fw-normal mb-0">
            {% if traveler.title and traveler.first_name != 'Inconnu' and traveler.last_name != 'Inconnu' and traveler.nationality and traveler.date_of_birth and traveler.gender %}
            <a href="#"><i class="bi bi-check-circle-fill text-success me-2"></i>Informations de base complètes</a>
            {% else %}
            <a href="#personal-info" class="text-primary"><i class="bi bi-plus-circle-fill me-2"></i>Compléter les informations de base</a>
            {% endif %}
          </li>
        </ul>
      </div>
    </div>

    <!-- Personal info START -->
    <div class="card border" id="personal-info">
      <!-- Card header -->
      <div class="card-header border-bottom">
        <h4 class="card-header-title">Informations personnelles</h4>
      </div>

      <!-- Card body START -->
      <div class="card-body">
        <!-- Form START -->
        <form class="row g-3" method="post" action="{% url 'pages:account_profile' %}" enctype="multipart/form-data">
          {% csrf_token %}
          <input type="hidden" name="form_type" value="profile">
          <!-- Profile photo -->
          <div class="col-12">
            <label class="form-label">Photo de profil</label>
            <div class="d-flex align-items-center">
              <label class="position-relative me-4" for="uploadfile-1" title="Remplacer cette photo">
                <!-- Avatar place holder -->
                <span class="avatar avatar-xl">
                  <img id="uploadfile-1-preview"
                       class="avatar-img rounded-circle border border-white border-3 shadow"
                       src="{% if traveler.profile_photo %}{{ traveler.profile_photo.url }}{% else %}{% static 'images/avatar/01.jpg' %}{% endif %}"
                       alt="Photo de profil">
                </span>
              </label>
              <!-- Upload button -->
              <label class="btn btn-sm btn-primary-soft mb-0" for="uploadfile-1">Changer</label>
              <input id="uploadfile-1" name="profile_photo" class="form-control d-none" type="file" accept="image/*">
            </div>
          </div>

          <!-- Title -->
          <div class="col-md-6">
            <label class="form-label">Titre</label>
            <select class="form-select js-choice" name="title">
              <option value="">Sélectionner un titre</option>
              {% for value, label in title_choices %}
              <option value="{{ value }}" {% if value == traveler.title %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Name -->
          <div class="col-md-6">
            <label class="form-label">Nom complet<span class="text-danger">*</span></label>
            <input type="text" class="form-control" name="first_name" value="{{ traveler.first_name }}"
                   placeholder="Entrez votre prénom" required>
            <input type="text" class="form-control mt-2" name="last_name" value="{{ traveler.last_name }}"
                   placeholder="Entrez votre nom" required>
          </div>

          <!-- Email -->
          <div class="col-md-6">
            <label class="form-label">Adresse email</label>
            <input type="email" class="form-control" name="email" value="{{ traveler.email|default_if_none:'' }}"
                   placeholder="Entrez votre email">
          </div>

          <!-- Mobile -->
          <div class="col-md-6">
            <label class="form-label">Numéro de téléphone</label>
            <input type="text" class="form-control" name="phone_number" value="{{ traveler.phone_number|default_if_none:'' }}"
                   placeholder="Entrez votre numéro de téléphone">
          </div>

          <!-- Nationality -->
          <div class="col-md-6">
            <label class="form-label">Nationalité</label>
            <select class="form-select js-choice" name="nationality">
              <option value="">Sélectionner votre pays</option>
              {% for country in countries %}
              <option value="{{ country }}" {% if country == traveler.nationality %}selected{% endif %}>{{ country }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Date of birth -->
          <div class="col-md-6">
            <label class="form-label">Date de naissance</label>
            <input type="text" class="form-control flatpickr" name="date_of_birth"
                   value="{% if traveler.date_of_birth %}{{ traveler.date_of_birth|date:'d M Y' }}{% endif %}"
                   placeholder="Entrez votre date de naissance" data-date-format="d M Y">
          </div>

          <!-- Gender -->
          <div class="col-md-6">
            <label class="form-label">Genre</label>
            <div class="d-flex gap-4">
              {% for value, label in gender_choices %}
              <div class="form-check radio-bg-light">
                <input class="form-check-input" type="radio" name="gender" value="{{ value }}"
                       id="gender{{ value|capfirst }}" {% if traveler.gender == value %}checked{% endif %}>
                <label class="form-check-label" for="gender{{ value|capfirst }}">{{ label }}</label>
              </div>
              {% endfor %}
            </div>
          </div>

          <!-- Address -->
          <div class="col-12">
            <label class="form-label">Adresse</label>
            <textarea class="form-control" name="address" rows="3"
                      spellcheck="false">{{ traveler.address|default_if_none:'' }}</textarea>
          </div>

          <!-- Button -->
          <div class="col-12 text-end">
            <button type="submit" class="btn btn-primary mb-0">Enregistrer les modifications</button>
          </div>
        </form>
        <!-- Form END -->
      </div>
      <!-- Card body END -->
    </div>
    <!-- Personal info END -->

    <!-- Update email START -->
    <div class="card border" id="update-email">
      <!-- Card header -->
      <div class="card-header border-bottom">
        <h4 class="card-header-title">Mettre à jour l'email</h4>
        <p class="mb-0">Votre adresse email actuelle est <span class="text-primary">{{ user.email }}</span></p>
      </div>

      <!-- Card body START -->
      <div class="card-body">
        <form method="post" action="{% url 'pages:account_profile' %}">
          {% csrf_token %}
          <input type="hidden" name="form_type" value="email">
          <!-- Email -->
          <label class="form-label">Entrez votre nouvel email<span class="text-danger">*</span></label>
          <input type="email" class="form-control" name="email" placeholder="Entrez votre email" required>
          <div class="text-end mt-3">
            <button type="submit" class="btn btn-primary mb-0">Enregistrer l'email</button>
          </div>
        </form>
      </div>
      <!-- Card body END -->
    </div>
    <!-- Update email END -->

    <!-- Update Password START -->
    <div class="card border">
      <!-- Card header -->
      <div class="card-header border-bottom">
        <h4 class="card-header-title">Mettre à jour le mot de passe</h4>
        <p class="mb-0">Votre adresse email actuelle est <span class="text-primary">{{ user.email }}</span></p>
      </div>

      <!-- Card body START -->
      <form class="card-body" method="post" action="{% url 'pages:account_profile' %}">
        {% csrf_token %}
        <input type="hidden" name="form_type" value="password">
        <!-- Current password -->
        <div class="mb-3">
          <label class="form-label">Mot de passe actuel</label>
          <input class="form-control" type="password" name="old_password" placeholder="Entrez le mot de passe actuel" required>
        </div>
        <!-- New password -->
        <div class="mb-3">
          <label class="form-label">Nouveau mot de passe</label>
          <div class="input-group">
            <input class="form-control fakepassword" name="new_password1" placeholder="Entrez le nouveau mot de passe" type="password"
                   id="psw-input" required>
            <span class="input-group-text p-0 bg-transparent">
              <i class="fakepasswordicon fas fa-eye-slash cursor-pointer p-2"></i>
            </span>
          </div>
        </div>
        <!-- Confirm -->
        <div class="mb-3">
          <label class="form-label">Confirmez le nouveau mot de passe</label>
          <input class="form-control" type="password" name="new_password2" placeholder="Confirmez le nouveau mot de passe" required>
        </div>
        <div class="text-end">
          <button type="submit" class="btn btn-primary mb-0">Changer le mot de passe</button>
        </div>
      </form>
      <!-- Card body END -->
    </div>
    <!-- Update Password END -->
  </div>
</div>

<!-- JavaScript for profile photo preview and password toggle -->
<script>
  // Profile photo preview
  document.getElementById('uploadfile-1').addEventListener('change', function(event) {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        document.getElementById('uploadfile-1-preview').src = e.target.result;
      };
      reader.readAsDataURL(file);
    }
  });

  // Password visibility toggle
  document.querySelector('.fakepasswordicon').addEventListener('click', function() {
    const input = document.getElementById('psw-input');
    const icon = this;
    if (input.type === 'password') {
      input.type = 'text';
      icon.classList.remove('fa-eye-slash');
      icon.classList.add('fa-eye');
    } else {
      input.type = 'password';
      icon.classList.remove('fa-eye');
      icon.classList.add('fa-eye-slash');
    }
  });
</script>
{% endblock page_content %}
