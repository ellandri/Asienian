{% extends 'admin.html' %}
{% load static i18n %}

{% block page_content %}
<!-- Title -->
<form style="display: none;" id="csrf-form">
  {% csrf_token %}
</form>
<div class="row">
  <div class="col-12 mb-4 mb-sm-5">
    <h1 class="h3 mb-0">Gestion des avis sur l'entreprise</h1>
  </div>
</div>

<!-- Review box START -->
<div class="row g-4 g-xl-5 mb-5">
  <div class="col-md-6 col-lg-4">
    <div class="bg-light p-4 rounded text-center">
      <h6 class="fw-normal">Total des avis</h6>
      <div class="d-flex align-items-center justify-content-center">
        <h2 class="mb-0 me-2">{{ total_reviews }}</h2>
        <div class="badge bg-success bg-opacity-10 text-success">{{ growth_percentage }}% <i class="bi bi-graph-up"></i></div>
      </div>
      <p class="mb-0">Croissance des avis cette année</p>
    </div>
  </div>
</div>
<!-- Review box END -->

<!-- Tab and select -->
<div class="row g-4 justify-content-between align-items-center">
  <div class="col-lg-5">
    <!-- Tabs -->
    <ul class="nav nav-pills-shadow nav-responsive" role="tablist">
      <li class="nav-item" role="presentation">
        <a class="nav-link mb-0 me-sm-2 {% if selected_status == 'all' %}active{% endif %}" href="?status=all" role="tab">Tous les avis</a>
      </li>
      <li class="nav-item" role="presentation">
        <a class="nav-link mb-0 me-sm-2 {% if selected_status == 'published' %}active{% endif %}" href="?status=published" role="tab">Publiés</a>
      </li>
<!--      <li class="nav-item" role="presentation">-->
<!--        <a class="nav-link mb-0 {% if selected_status == 'deleted' %}active{% endif %}" href="?status=deleted" role="tab">Supprimés</a>-->
<!--      </li>-->
    </ul>
  </div>

  <!-- Select -->
  <div class="col-md-6 col-lg-3">
    <form>
      <select class="form-select js-choice" name="trip_id" onchange="this.form.submit()">
        <option value="">Tous les voyages</option>
        {% for trip in trips %}
        <option value="{{ trip.id }}" {% if selected_trip_id == trip.id|stringformat:"s" %}selected{% endif %}>{{ trip.departure_city }} à {{ trip.arrival_city }}</option>
        {% endfor %}
      </select>
    </form>
  </div>
</div>

<!-- Reviews START -->
<div class="vstack gap-4 mt-5">
  {% for review in reviews %}
  <!-- Review item -->
  <div class="row g-3 g-lg-4">
    <div class="col-md-4 col-xxl-3">
      <!-- Avatar and info -->
      <div class="d-flex align-items-center">
        <!-- Avatar -->
        <div class="avatar avatar-xl me-2 flex-shrink-0">
          <img class="avatar-img rounded-circle" src="{% static 'images/avatar/09.jpg' %}" alt="avatar">
        </div>
        <!-- Info -->
        <div class="ms-2">
          <h5 class="mb-1">{{ review.user.first_name }} {{ review.user.last_name }}</h5>
          <p class="mb-0">Avis publié le {{ review.created_at|date:"d M Y" }}</p>
        </div>
      </div>
    </div>

    <div class="col-md-8 col-xxl-9">
      <h6><span class="text-body fw-light">Avis sur l'entreprise</span> {% if review.trip %}(lié au voyage : {{ review.trip.departure_city }} à {{ review.trip.arrival_city }}){% else %}(Avis général){% endif %}</h6>
      <p>{{ review.comment|truncatechars:200 }}</p>
      <div class="d-flex align-items-center mb-2">
        <span class="text-warning">
          {% for i in "12345" %}
            <i class="bi bi-star-fill {% if forloop.counter <= review.rating %}text-warning{% else %}text-muted{% endif %}"></i>
          {% endfor %}
        </span>
        <span class="ms-2">({{ review.rating }}/5)</span>
      </div>

      <!-- Buttons -->
      <div class="d-flex justify-content-end align-items-center">
        {% if review.is_published %}
        <a href="#" class="text-primary-hover unpublish-review me-2" data-id="{{ review.id }}"><i class="bi bi-eye-slash me-1"></i>Dépublier</a>
        {% else %}
        <a href="#" class="text-primary-hover publish-review me-2" data-id="{{ review.id }}"><i class="bi bi-eye me-1"></i>Publier</a>
        {% endif %}
<!--        {% if not review.is_deleted %}-->
<!--        <a href="#" class="text-primary-hover delete-review" data-id="{{ review.id }}"><i class="bi bi-trash3 me-1"></i>Supprimer</a>-->
<!--        {% endif %}-->
      </div>
    </div>
  </div>
  <hr class="m-0">
  {% empty %}
  <div class="row">
    <div class="col-12">
      <p>Aucun avis trouvé.</p>
    </div>
  </div>
  {% endfor %}

  <!-- Pagination START -->
  <div class="d-sm-flex justify-content-sm-between align-items-sm-center">
    <p class="mb-sm-0 text-center text-sm-start">Affichage de {{ reviews.start_index }} à {{ reviews.end_index }} sur {{ reviews.paginator.count }} entrées</p>
    <nav class="mb-sm-0 d-flex justify-content-center" aria-label="navigation">
      <ul class="pagination pagination-sm pagination-primary-soft mb-0">
        {% if reviews.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?page={{ reviews.previous_page_number }}{% if selected_status %}&status={{ selected_status }}{% endif %}{% if selected_trip_id %}&trip_id={{ selected_trip_id }}{% endif %}">Précédent</a>
        </li>
        {% else %}
        <li class="page-item disabled">
          <a class="page-link" href="#" tabindex="-1">Précédent</a>
        </li>
        {% endif %}
        {% for num in reviews.paginator.page_range %}
        <li class="page-item {% if reviews.number == num %}active{% endif %}">
          <a class="page-link" href="?page={{ num }}{% if selected_status %}&status={{ selected_status }}{% endif %}{% if selected_trip_id %}&trip_id={{ selected_trip_id }}{% endif %}">{{ num }}</a>
        </li>
        {% endfor %}
        {% if reviews.has_next %}
        <li class="page-item">
          <a class="page-link" href="?page={{ reviews.next_page_number }}{% if selected_status %}&status={{ selected_status }}{% endif %}{% if selected_trip_id %}&trip_id={{ selected_trip_id }}{% endif %}">Suivant</a>
        </li>
        {% else %}
        <li class="page-item disabled">
          <a class="page-link" href="#">Suivant</a>
        </li>
        {% endif %}
      </ul>
    </nav>
  </div>
  <!-- Pagination END -->
</div>
<!-- Reviews END -->
{% endblock page_content %}

{% block extra_javascript %}
<script>
  // Handle publish action
  document.querySelectorAll('.publish-review').forEach(button => {
    button.addEventListener('click', async (event) => {
      event.preventDefault();
      if (confirm('Voulez-vous vraiment publier cet avis ?')) {
        const reviewId = button.dataset.id;
        const response = await fetch(`/backoffice/publish-review/${reviewId}/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/x-www-form-urlencoded'
          }
        });
        const data = await response.json();
        alert(data.message);
        if (data.success) window.location.reload();
      }
    });
  });

  // Handle unpublish action
  document.querySelectorAll('.unpublish-review').forEach(button => {
    button.addEventListener('click', async (event) => {
      event.preventDefault();
      if (confirm('Voulez-vous vraiment dépublier cet avis ?')) {
        const reviewId = button.dataset.id;
        const response = await fetch(`/backoffice/unpublish-review/${reviewId}/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/x-www-form-urlencoded'
          }
        });
        const data = await response.json();
        alert(data.message);
        if (data.success) window.location.reload();
      }
    });
  });


  document.addEventListener('DOMContentLoaded', () => {
    // Handle delete action
    document.querySelectorAll('.delete-review').forEach(button => {
      button.addEventListener('click', async (event) => {
        event.preventDefault();
        console.log('Delete button clicked for review ID:', button.dataset.id);
        if (confirm('Voulez-vous vraiment marquer cet avis comme supprimé ?')) {
          const reviewId = button.dataset.id;
          const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
          if (!csrfToken) {
            console.error('CSRF token not found');
            alert('Erreur : Jeton CSRF non trouvé. Veuillez recharger la page.');
            return;
          }
          try {
            const response = await fetch(`/backoffice/delete-review/${reviewId}/`, {
              method: 'POST',
              headers: {
                'X-CSRFToken': csrfToken.value,
                'Content-Type': 'application/x-www-form-urlencoded'
              }
            });
            const data = await response.json();
            console.log('Response:', data);
            alert(data.message);
            if (data.success) {
              window.location.reload();
            } else {
              console.error('Delete failed:', data.message);
            }
          } catch (error) {
            console.error('Fetch error:', error);
            alert('Erreur lors de la suppression de l\'avis : ' + error.message);
          }
        }
      });
    });
  });
</script>
{% endblock extra_javascript %}
