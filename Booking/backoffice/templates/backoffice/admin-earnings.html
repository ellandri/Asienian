{% extends 'admin.html' %}
{% load static i18n %}

{% block page_content %}
<!-- Page main content START -->
<div class="page-content-wrapper p-xxl-4">
  <!-- Title -->
  <div class="row">
    <div class="col-12 mb-4 mb-sm-5">
      <h1 class="h3 mb-0">Gains</h1>
    </div>
  </div>

  <!-- Earning block START -->
  <div class="row g-4">
    <!-- Block item -->
    <div class="col-sm-6 col-xxl-3">
      <div class="card card-body bg-light p-4 h-100">
        <h6 class="mb-0">Revenu quotidien moyen</h6>
        <h3 class="mb-2 mt-2">{{ daily_earnings|floatformat:0 }} FCFA</h3>
        <p class="mt-auto mb-0">Augmentation <span class="badge bg-success bg-opacity-10 text-success">10% <i class="bi bi-graph-up"></i></span></p>
      </div>
    </div>

    <!-- Block item -->
    <div class="col-sm-6 col-xxl-3">
      <div class="card card-body bg-light p-4 h-100">
        <h6 class="mb-0">Revenu ce mois-ci</h6>
        <h3 class="mb-2 mt-2">{{ monthly_revenue|floatformat:0 }} FCFA</h3>
        <p class="mt-auto mb-0">Augmentation par rapport au mois dernier <span class="badge bg-success bg-opacity-10 text-success">21% <i class="bi bi-graph-up"></i></span></p>
      </div>
    </div>

    <!-- Block item -->
    <div class="col-sm-6 col-xxl-3">
      <div class="card card-body bg-light p-4 h-100">
        <h6>En attente
          <a tabindex="0" class="h6 mb-0" role="button" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-placement="top" data-bs-content="Après retenue fiscale">
            <i class="bi bi-info-circle-fill small"></i>
          </a>
        </h6>
        <h3>{{ on_hold|floatformat:0 }} FCFA</h3>
        <p class="mb-0 mt-auto">Paiement attendu le {% now "d/m/Y" %}</p>
      </div>
    </div>

    <!-- Block item -->
    <div class="col-sm-6 col-xxl-3">
      <div class="card bg-primary p-4">
        <div class="d-flex justify-content-between align-items-start text-white">
          <img class="w-40px" src="{% static 'images/element/visa.svg' %}" alt="">
          <!-- Card action START -->
          <div class="dropdown">
            <a class="text-white" href="#" id="creditcardDropdown" role="button" data-bs-toggle="dropdown" data-bs-auto-close="outside" aria-expanded="false">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle fill="currentColor" cx="12.5" cy="3.5" r="2.5"></circle>
                <circle fill="currentColor" opacity="0.5" cx="12.5" cy="11.5" r="2.5"></circle>
                <circle fill="currentColor" opacity="0.3" cx="12.5" cy="19.5" r="2.5"></circle>
              </svg>
            </a>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="creditcardDropdown">
              <li><a class="dropdown-item" href="javascript:void(0)" onclick="editCard({{ bookings.first.id|default:0 }})"><i class="bi bi-credit-card-2-front-fill me-2 fw-icon"></i>Modifier la carte</a></li>
              <li><a class="dropdown-item" href="#"><i class="bi bi-credit-card me-2 fw-icon"></i>Ajouter une nouvelle carte</a></li>
              <li><a class="dropdown-item" href="#"><i class="bi bi-arrow-bar-down me-2 fw-icon"></i>Retirer de l'argent</a></li>
              <li><a class="dropdown-item" href="#"><i class="bi bi-calculator me-2 fw-icon"></i>Convertisseur de devises</a></li>
            </ul>
          </div>
          <!-- Card action END -->
        </div>
        <div class="mt-4 text-white">
          <span>Solde total</span>
          <h3 class="text-white mb-0">{{ total_balance|floatformat:0 }} FCFA</h3>
        </div>
        <h5 class="text-white mt-4">**** **** **** {{ card_number }}</h5>
        <div class="d-flex justify-content-between text-white">
          <span>Valide jusqu'au : {{ card_expiry }}</span>
          <span>CVV: ***</span>
        </div>
      </div>
    </div>
  </div>
  <!-- Earning block END -->

  <!-- Payment history START -->
  <div class="card shadow mt-5">
    <!-- Card header -->
    <div class="card-header border-bottom">
      <h5 class="card-title mb-0">Historique des paiements</h5>
    </div>

    <!-- Card body START -->
    <div class="card-body">
      <!-- Table head -->
      <div class="bg-light rounded p-3 d-none d-sm-block">
        <div class="row row-cols-7 g-4">
          <div class="col"><h6 class="mb-0">ID Facture</h6></div>
          <div class="col"><h6 class="mb-0">Date</h6></div>
          <div class="col"><h6 class="mb-0">Montant</h6></div>
          <div class="col"><h6 class="mb-0">Statut</h6></div>
          <div class="col"><h6 class="mb-0">Action</h6></div>
        </div>
      </div>

      <!-- Table data -->
      {% for booking in bookings %}
      <div class="row row-cols-xl-7 g-4 align-items-sm-center border-bottom px-2 py-4">
        <!-- Data item -->
        <div class="col">
          <small class="d-block d-sm-none">Réservé par :</small>
          <h6 class="fw-light mb-0">#{{ booking.id }}</h6>
        </div>

        <!-- Data item -->
        <div class="col">
          <small class="d-block d-sm-none">Date :</small>
          <h6 class="mb-0 fw-normal">{{ booking.created_at|date:"d M Y" }}</h6>
        </div>

        <!-- Data item -->
        <div class="col position-relative">
          <small class="d-block d-sm-none">Montant :</small>
          <div class="d-flex">
            <h6 class="mb-0 me-1">{{ booking.trip.price|floatformat:0 }} FCFA</h6>
            <a href="#" class="h6 mb-0" role="button" id="dropdownShare{{ booking.id }}" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="bi bi-info-circle-fill"></i>
            </a>
            <ul class="dropdown-menu dropdown-w-sm dropdown-menu-end min-w-auto shadow rounded" aria-labelledby="dropdownShare{{ booking.id }}">
              <li>
                <div class="d-flex justify-content-between">
                  <span class="small">Commission</span>
                  <span class="h6 mb-0 small ms-2">{{ booking.get_commission|floatformat:0 }} FCFA</span>
                </div>
                <hr class="my-1">
              </li>
              <li>
                <div class="d-flex justify-content-between">
                  <span class="me-4 small">Taxe</span>
                  <span class="text-danger small ms-2">{{ booking.get_tax|floatformat:0 }} FCFA</span>
                </div>
                <hr class="my-1">
              </li>
              <li>
                <div class="d-flex justify-content-between">
                  <span class="small">Gains</span>
                  <span class="h6 mb-0 small ms-2">{{ booking.get_earnings|floatformat:0 }} FCFA</span>
                </div>
              </li>
            </ul>
          </div>
        </div>

        <!-- Data item -->
        <div class="col">
          <small class="d-block d-sm-none">Statut :</small>
          <div class="badge bg-{% if booking.payment_status == 'paid' %}success{% elif booking.payment_status == 'pending' %}warning{% else %}danger{% endif %} bg-opacity-10 text-{% if booking.payment_status == 'paid' %}success{% elif booking.payment_status == 'pending' %}warning{% else %}danger{% endif %}">
            {{ booking.get_payment_status_display }}
          </div>
        </div>

        <!-- Data item -->
        <div class="col">
          <a href="{% url 'backoffice:download_invoice' booking.id %}" class="btn btn-light btn-round mb-0"><i class="bi bi-cloud-download"></i></a>
        </div>
      </div>
      {% empty %}
      <div class="row">
        <div class="col-12">
          <p>Aucune réservation trouvée.</p>
        </div>
      </div>
      {% endfor %}
    </div>
    <!-- Card body END -->

    <!-- Card footer START -->
    <div class="card-footer pt-0">
      <div class="d-sm-flex justify-content-sm-between align-items-sm-center">
        <p class="mb-sm-0 text-center text-sm-start">Affichage de {{ bookings.start_index }} à {{ bookings.end_index }} sur {{ bookings.paginator.count }} entrées</p>
        <nav class="mb-sm-0 d-flex justify-content-center" aria-label="navigation">
          <ul class="pagination pagination-sm pagination-primary-soft mb-0">
            {% if bookings.has_previous %}
            <li class="page-item">
              <a class="page-link" href="?page={{ bookings.previous_page_number }}">Précédent</a>
            </li>
            {% else %}
            <li class="page-item disabled">
              <a class="page-link" href="#" tabindex="-1">Précédent</a>
            </li>
            {% endif %}

            {% for num in bookings.paginator.page_range %}
            <li class="page-item {% if bookings.number == num %}active{% endif %}">
              <a class="page-link" href="?page={{ num }}">{{ num }}</a>
            </li>
            {% endfor %}

            {% if bookings.has_next %}
            <li class="page-item">
              <a class="page-link" href="?page={{ bookings.next_page_number }}">Suivant</a>
            </li>
            {% else %}
            <li class="page-item disabled">
              <a class="page-link" href="#">Suivant</a>
            </li>
            {% endif %}
          </ul>
        </nav>
      </div>
    </div>
    <!-- Card footer END -->
  </div>
  <!-- Payment history END -->
  {% block extra_js %}
  <script>
    function editCard(bookingId) {
      const cardNumber = prompt("Entrez le nouveau numéro de carte (16 chiffres) :");
      const expiryMonth = prompt("Entrez le mois d'expiration (MM) :");
      const expiryYear = prompt("Entrez l'année d'expiration (YYYY) :");
      const cvv = prompt("Entrez le CVV (3 chiffres) :");
      const cardholderName = prompt("Entrez le nom du titulaire :");

      fetch("{% url 'backoffice:edit_card' 0 %}".replace('0', bookingId), {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: `card_number=${cardNumber}&card_expiry_month=${expiryMonth}&card_expiry_year=${expiryYear}&card_cvv=${cvv}&cardholder_name=${cardholderName}`
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert(data.message);
            document.querySelector('.card-number').textContent = `**** **** **** ${data.card_number}`;
            document.querySelector('.card-expiry').textContent = `Valide jusqu'au : ${data.card_expiry}`;
          } else {
            alert(data.message);
          }
        });
    }
  </script>
  {% endblock %}
</div>
{% endblock page_content %}
