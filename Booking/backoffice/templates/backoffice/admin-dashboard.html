{% extends 'admin.html' %}
{% load static i18n %}

{% block page_content %}
<!-- Contenu principal START -->
<div class="page-content-wrapper p-3 p-md-4 p-xxl-5 bg-light">
  <!-- Titre -->
  <div class="row align-items-center mb-4 mb-md-5">
    <div class="col-12 col-md-8">
      <h1 class="h2 mb-0 text-dark font-weight-bold animate__animated animate__fadeIn">
        {% trans "Tableau de bord" %}
      </h1>
      <p class="text-muted mb-0">{% trans "Gérez efficacement vos voyages, réservations et avis." %}</p>
    </div>
    <div class="col-12 col-md-4 text-md-end mt-3 mt-md-0">
      <a href="{% url 'backoffice:admin-add-trip-form' %}" class="btn btn-primary btn-lg shadow-sm animate__animated animate__pulse animate__infinite">
        <i class="bi bi-plus-lg fa-fw me-2"></i> {% trans "Nouveau voyage" %}
      </a>
    </div>
  </div>

  <!-- Boîtes de compteurs START -->
  <div class="row g-4 mb-5">
    <!-- Compteur : Total des voyages -->
    <div class="col-md-6 col-xxl-3 animate__animated animate__fadeInUp animate__delay-1s">
      <div class="card card-body bg-gradient-warning shadow-sm border-0 p-4 h-100 transition-hover counter-card">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h3 class="mb-0 text-dark">{{ total_trips }}</h3>
            <span class="h6 fw-light text-dark">{% trans "Total des voyages" %}</span>
          </div>
          <div class="icon-lg rounded-circle bg-warning text-white">
            <i class="fa-solid fa-plane-departure fa-fw"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- Compteur : Revenu total -->
    <div class="col-md-6 col-xxl-3 animate__animated animate__fadeInUp animate__delay-2s">
      <div class="card card-body bg-gradient-success shadow-sm border-0 p-4 h-100 transition-hover counter-card">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h3 class="mb-0 text-dark">{{ total_income|floatformat:0 }} FCFA</h3>
            <span class="h6 fw-light text-dark">{% trans "Revenu total" %}</span>
          </div>
          <div class="icon-lg rounded-circle bg-success text-white">
            <i class="fa-solid fa-hand-holding-dollar fa-fw"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- Compteur : Total des sièges -->
    <div class="col-md-6 col-xxl-3 animate__animated animate__fadeInUp animate__delay-3s">
      <div class="card card-body bg-gradient-primary shadow-sm border-0 p-4 h-100 transition-hover counter-card">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h3 class="mb-0 text-dark">{{ total_seats }}</h3>
            <span class="h6 fw-light text-dark">{% trans "Total des sièges" %}</span>
          </div>
          <div class="icon-lg rounded-circle bg-primary text-white">
            <i class="fa-solid fa-chair fa-fw"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- Compteur : Sièges réservés -->
    <div class="col-md-6 col-xxl-3 animate__animated animate__fadeInUp animate__delay-4s">
      <div class="card card-body bg-gradient-info shadow-sm border-0 p-4 h-100 transition-hover counter-card">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h3 class="mb-0 text-dark">{{ booked_seats }}</h3>
            <span class="h6 fw-light text-dark">{% trans "Sièges réservés" %}</span>
          </div>
          <div class="icon-lg rounded-circle bg-info text-white">
            <i class="fa-solid fa-building-circle-check fa-fw"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Boîtes de compteurs END -->

  <!-- Grille des voyages START -->
  <div class="row g-4 mb-5">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <h4 class="mb-0 text-dark font-weight-bold">{% trans "Voyages populaires" %}</h4>
        <a href="{% url 'backoffice:admin_booking_list' %}" class="btn btn-outline-primary btn-sm">{% trans "Voir tout" %}</a>
      </div>
    </div>

    {% for trip in popular_trips %}
    <div class="col-lg-6 animate__animated animate__fadeIn">
      <div class="card shadow-sm border-0 p-3 h-100 transition-hover">
        <div class="row g-3">
          <!-- Image de la carte -->
          <div class="col-md-3">
            <img src="{{ trip.image|default:'/static/images/category/hotel/4by3/10.jpg' }}" class="rounded-3 img-fluid" alt="{{ trip.title }}">
          </div>
          <!-- Corps de la carte -->
          <div class="col-md-9">
            <div class="card-body position-relative d-flex flex-column p-0 h-100">
              <!-- Menu déroulant -->
              <div class="dropdown position-absolute top-0 end-0">
                <a href="#" class="btn btn-sm btn-round btn-light shadow-sm" role="button" id="dropdownAction{{ trip.id }}"
                   data-bs-toggle="dropdown" aria-expanded="false">
                  <i class="bi bi-three-dots-vertical"></i>
                </a>
                <ul class="dropdown-menu dropdown-menu-end shadow" aria-labelledby="dropdownAction{{ trip.id }}">
                  <li><a class="dropdown-item small" href="{% url 'backoffice:admin-trip-detail' trip.id %}"><i class="bi bi-info-circle me-2"></i>{% trans "Détails" %}</a></li>
                  <li><a class="dropdown-item small" href="#" onclick="toggleTripStatus({{ trip.id }})"><i class="bi bi-slash-circle me-2"></i>{% if trip.is_active %}{% trans "Désactiver" %}{% else %}{% trans "Activer" %}{% endif %}</a></li>
                </ul>
              </div>
              <!-- Titre -->
              <h5 class="card-title mb-1 text-dark">
                <a href="{% url 'backoffice:admin-trip-detail' trip.id %}" class="text-decoration-none">{{ trip.title }}</a>
              </h5>
              <small class="text-muted"><i class="bi bi-geo-alt me-2"></i>{{ trip.departure_city }} - {{ trip.arrival_city }}</small>
              <!-- Prix et boutons -->
              <div class="d-sm-flex justify-content-sm-between align-items-center mt-3">
                <div class="d-flex align-items-center">
                  <h5 class="fw-bold mb-0 me-1 text-primary">{{ trip.price }} FCFA</h5>
                  <span class="text-muted small">{% trans "/voyage" %}</span>
                </div>
                <div class="hstack gap-2 mt-2 mt-sm-0">
                  <a href="{% url 'backoffice:trip_edit' trip.id %}" class="btn btn-sm btn-outline-primary px-3"><i class="bi bi-pencil-square fa-fw me-1"></i>{% trans "Modifier" %}</a>
                  <a href="#" onclick="toggleTripStatus({{ trip.id }})" class="btn btn-sm btn-outline-danger px-3"><i class="bi bi-slash-circle fa-fw me-1"></i>{% trans "Désactiver" %}</a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% empty %}
    <div class="col-12">
      <div class="alert alert-warning border-0">{% trans "Aucun voyage populaire disponible." %}</div>
    </div>
    {% endfor %}
  </div>
  <!-- Grille des voyages END -->

  <!-- Widgets START -->
  <div class="row g-4">
    <!-- Graphique de l'activité des clients START -->
    <div class="col-xxl-8 animate__animated animate__fadeIn">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-header border-bottom bg-white p-3">
          <h5 class="card-header-title text-dark">{% trans "Activité des clients" %}</h5>
        </div>
        <div class="card-body p-4">
          <div class="d-flex gap-4 mb-4">
            <h6 class="text-muted"><i class="bi bi-square-fill text-primary me-2"></i> {% trans "Arrivée" %}: <span class="text-dark">{{ check_ins }} {% trans "Clients" %}</span></h6>
            <h6 class="text-muted"><i class="bi bi-square-fill text-info me-2"></i> {% trans "Départ" %}: <span class="text-dark">{{ check_outs }} {% trans "Clients" %}</span></h6>
          </div>
          <div id="ChartGuesttraffic" class="chart-container"></div>
        </div>
      </div>
    </div>
    <!-- Graphique de l'activité des clients END -->

    <!-- Graphique de disponibilité des sièges START -->
    <div class="col-lg-6 col-xxl-4 animate__animated animate__fadeIn">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-header border-bottom bg-white p-3">
          <h5 class="card-header-title text-dark">{% trans "Disponibilité des sièges" %}</h5>
        </div>
        <div class="card-body p-4">
          <div class="col-sm-8 col-md-6 mx-auto mb-3">
            <div id="ChartTrafficSeats" class="chart-container"></div>
          </div>
          <ul class="list-group list-group-borderless mb-0">
            <li class="list-group-item d-flex justify-content-between text-muted">
              <span><i class="text-success fas fa-circle me-2"></i> {% trans "Disponible" %}</span>
              <span class="text-dark">{{ available_seats }} {% trans "Sièges" %}</span>
            </li>
            <li class="list-group-item d-flex justify-content-between text-muted">
              <span><i class="text-danger fas fa-circle me-2"></i> {% trans "Réservé" %}</span>
              <span class="text-dark">{{ booked_seats }} {% trans "Sièges" %}</span>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <!-- Graphique de disponibilité des sièges END -->

    <!-- Notifications de voyage START -->
    <div class="col-lg-6 col-xxl-4 animate__animated animate__fadeIn">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-header border-bottom bg-white p-3 d-flex justify-content-between align-items-center">
          <h5 class="card-header-title text-dark">{% trans "Notifications de voyage" %}</h5>
          <a href="{% url 'backoffice:admin_booking_list' %}" class="btn btn-link text-primary p-0">{% trans "Voir tout" %}</a>
        </div>
        <div class="card-body p-3">
          {% for booking in recent_bookings %}
          <div class="d-flex justify-content-between align-items-center mb-3 transition-hover">
            <div class="d-sm-flex align-items-center">
              <div class="flex-shrink-0">
                <img src="{{ booking.trip.image|default:'/static/images/category/hotel/4by3/04.jpg' }}" class="rounded h-60px img-fluid" alt="{{ booking.trip.title }}">
              </div>
              <div class="ms-sm-3 mt-2 mt-sm-0">
                <h6 class="mb-1 text-dark">{{ booking.trip.title }}</h6>
                <ul class="nav nav-divider small text-muted">
                  <li class="nav-item">{{ booking.created_at|date:"d M Y" }}</li>
                  <li class="nav-item">
                    <span class="{% if booking.payment_status == 'paid' %}text-success{% elif booking.payment_status == 'canceled' %}text-danger{% else %}text-warning{% endif %}">
                      {{ booking.get_payment_status_display }}
                    </span>
                  </li>
                </ul>
              </div>
            </div>
            <a href="{% url 'backoffice:admin-trip-detail' booking.trip.id %}" class="btn btn-sm btn-outline-primary flex-shrink-0 px-3">{% trans "Voir" %}</a>
          </div>
          {% if not forloop.last %}<hr class="my-2">{% endif %}
          {% empty %}
          <div class="alert alert-warning border-0">{% trans "Aucune réservation récente." %}</div>
          {% endfor %}
        </div>
      </div>
    </div>
    <!-- Notifications de voyage END -->

    <!-- Arrivées prochaines START -->
    <div class="col-lg-6 col-xxl-4 animate__animated animate__fadeIn">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-header border-bottom bg-white p-3 d-flex justify-content-between align-items-center">
          <h5 class="card-header-title text-dark">{% trans "Arrivées prochaines" %}</h5>
          <a href="{% url 'backoffice:admin_guest_list' %}" class="btn btn-link text-primary p-0">{% trans "Voir tout" %}</a>
        </div>
        <div class="card-body p-3">
          {% for booking in upcoming_arrivals %}
          <div class="d-flex justify-content-between align-items-center mb-3 transition-hover">
            <div class="d-sm-flex align-items-center">

              <div class="ms-sm-2 mt-2 mt-sm-0">
                <h6 class="mb-1 text-dark">{{ booking.traveler.first_name }} {{ booking.traveler.last_name }}</h6>
                <ul class="nav nav-divider small text-muted">
                  <li class="nav-item">{{ booking.trip.title }}</li>
                  <li class="nav-item">{{ booking.created_at|date:"d M Y" }}</li>
                </ul>
              </div>
            </div>
            <a href="{% url 'backoffice:admin_agent_detail' booking.traveler.user.id %}" class="btn btn-sm btn-outline-primary px-2"><i class="fa-solid fa-chevron-right fa-fw"></i></a>
          </div>
          {% if not forloop.last %}<hr class="my-2">{% endif %}
          {% empty %}
          <div class="alert alert-warning border-0">{% trans "Aucune arrivée prochaine." %}</div>
          {% endfor %}
        </div>
      </div>
    </div>
    <!-- Arrivées prochaines END -->

    <!-- Avis START -->
    <div class="col-lg-6 col-xxl-4 animate__animated animate__fadeIn">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-header border-bottom bg-white p-3 d-flex justify-content-between align-items-center">
          <h5 class="card-header-title text-dark">{% trans "Avis" %}</h5>
          <a href="{% url 'backoffice:reviews' %}" class="btn btn-link text-primary p-0">{% trans "Voir tout" %}</a>
        </div>
        <div class="card-body p-3">
          {% for review in recent_reviews %}
          <div class="d-flex justify-content-between align-items-center mb-3 transition-hover">
            <div class="d-sm-flex align-items-center">
              <div class="flex-shrink-0">
                <img src="{{ review.trip.image|default:'/static/images/category/hotel/4by3/08.jpg' }}" class="rounded h-60px img-fluid" alt="{% if review.trip %}{{ review.trip.title }}{% else %}Aucun voyage{% endif %}">
              </div>
              <div class="ms-sm-3 mt-2 mt-sm-0">
                <h6 class="mb-1 text-dark">{% if review.trip %}{{ review.trip.title }}{% else %}Aucun voyage associé{% endif %}</h6>
                <ul class="list-inline smaller mb-0">
                  {% for i in "12345" %}
                  {% if forloop.counter0 < review.rating %}
                  <li class="list-inline-item me-0"><i class="fas fa-star text-warning"></i></li>
                  {% else %}
                  <li class="list-inline-item me-0"><i class="far fa-star text-warning"></i></li>
                  {% endif %}
                  {% endfor %}
                  <li class="list-inline-item text-muted">({{ review.trip.reviews.count|default:0 }} {% trans "avis" %})</li>
                </ul>
              </div>
            </div>
            {% if review.trip %}
            <a href="{% url 'backoffice:admin-trip-detail' review.trip.id %}" class="btn btn-sm btn-outline-primary px-3">{% trans "Voir" %}</a>
            {% else %}
            <span class="btn btn-sm btn-outline-secondary px-3 disabled">{% trans "Aucun voyage" %}</span>
            {% endif %}
          </div>
          {% if not forloop.last %}<hr class="my-2">{% endif %}
          {% empty %}
          <div class="alert alert-warning border-0">{% trans "Aucun avis disponible." %}</div>
          {% endfor %}
        </div>
      </div>
    </div>
    <!-- Avis END -->
  </div>
  <!-- Widgets END -->
</div>
<!-- Contenu principal END -->

{% block extra_css %}
<style>
  /* Styles généraux */
  .page-content-wrapper {
    background: linear-gradient(145deg, #f8f9fa, #e9ecef);
    border-radius: 12px;
    min-height: 100vh;
  }

  .font-weight-bold {
    font-weight: 700 !important;
  }

  /* Boîtes de compteurs */
  .bg-gradient-warning {
    background: linear-gradient(135deg, #ede0ba 0%, #f4e1a9 100%);
  }
  .bg-gradient-success {
    background: linear-gradient(135deg, #c7efd1 0%, #97edad 100%);
  }
  .bg-gradient-primary {
    background: linear-gradient(135deg, #9ebeed 0%, #b4cff6 100%);
  }
  .bg-gradient-info {
    background: linear-gradient(135deg, #c7f2f6 0%, #adedf3 100%);
  }

  .counter-card {
    position: relative;
    overflow: hidden;
    border-radius: 12px;
  }
  .counter-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.2);
    z-index: 0;
    transition: opacity 0.3s ease;
  }
  .counter-card:hover::before {
    opacity: 0;
  }
  .counter-card .card-body {
    position: relative;
    z-index: 1;
  }
  .counter-card h3 {
    font-size: 2.2rem;
    font-weight: 800;
    letter-spacing: -0.02em;
    transition: color 0.3s ease;
  }
  .counter-card:hover h3 {
    color: #1a3c8b; /* Bleu plus foncé au survol */
  }
  .counter-card .h6 {
    font-size: 0.9rem;
    opacity: 0.8;
  }
  .icon-lg {
    width: 60px;
    height: 60px;
    line-height: 60px;
    font-size: 1.8rem;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    transition: transform 0.3s ease;
  }
  .counter-card:hover .icon-lg {
    transform: scale(1.1);
  }

  /* Cartes de voyage */
  .card img {
    object-fit: cover;
    height: 100px;
    transition: transform 0.3s ease;
  }
  .card:hover img {
    transform: scale(1.05);
  }

  .btn-outline-primary, .btn-outline-danger, .btn-outline-secondary {
    border-radius: 8px;
    font-size: 0.9rem;
    padding: 0.5rem 1rem;
    transition: all 0.3s ease;
  }
  .btn-outline-primary:hover, .btn-outline-danger:hover {
    color: white !important;
  }

  .dropdown-menu {
    border-radius: 8px;
    border: none;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
  }

  /* Graphiques */
  .chart-container {
    min-height: 200px;
  }

  /* Notifications et arrivées */
  .avatar-img {
    object-fit: cover;
    width: 40px;
    height: 40px;
  }

  .list-group-item, .nav-divider {
    font-size: 0.9rem;
  }

  .alert-warning {
    background-color: #fff3cd;
    color: #664d03;
    border-radius: 8px;
  }

  /* Animations */
  .animate__animated {
    animation-duration: 0.8s;
  }

  /* Ajustements responsifs */
  @media (max-width: 768px) {
    .h2 {
      font-size: 1.5rem;
    }
    .btn-lg {
      font-size: 1rem;
      padding: 0.5rem 1rem;
    }
    .counter-card h3 {
      font-size: 1.6rem;
    }
    .icon-lg {
      width: 45px;
      height: 45px;
      line-height: 45px;
      font-size: 1.4rem;
    }
    .card img {
      height: 80px;
    }
  }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Basculer l'état du voyage
  function toggleTripStatus(tripId) {
    fetch("{% url 'backoffice:toggle_trip_status' 0 %}".replace('0', tripId), {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({})
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          window.location.reload();
        } else {
          alert('Erreur : ' + data.error);
        }
      })
      .catch(error => {
        alert('Erreur réseau : ' + error);
      });
  }

  // Graphique de l'activité des clients
  const guestTrafficData = {
    labels: {{ guest_traffic_labels|safe }},
  datasets: [
    {
      label: '{% trans "Arrivée" %}',
      data: {{ guest_traffic_check_ins|safe }},
  backgroundColor: 'rgba(13, 110, 253, 0.2)',
    borderColor: 'rgba(13, 110, 253, 1)',
    borderWidth: 2,
    tension: 0.4,
    pointRadius: 4,
    pointHoverRadius: 6
  },
  {
    label: '{% trans "Départ" %}',
      data: {{ guest_traffic_check_outs|safe }},
    backgroundColor: 'rgba(0, 193, 212, 0.2)',
      borderColor: 'rgba(0, 193, 212, 1)',
    borderWidth: 2,
    tension: 0.4,
    pointRadius: 4,
    pointHoverRadius: 6
  }
  ]
  };

  const guestTrafficConfig = {
    type: 'line',
    data: guestTrafficData,
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: { beginAtZero: true, grid: { color: 'rgba(0, 0, 0, 0.05)' } },
        x: { grid: { display: false } }
      },
      plugins: {
        legend: { position: 'top', labels: { font: { size: 12 } } },
        tooltip: { backgroundColor: '#333', titleFont: { size: 14 }, bodyFont: { size: 12 } }
      }
    }
  };

  const guestTrafficChart = new Chart(document.getElementById('ChartGuesttraffic'), guestTrafficConfig);

  // Graphique de disponibilité des sièges
  const seatAvailabilityData = {
    labels: ['{% trans "Disponible" %}', '{% trans "Réservé" %}'],
    datasets: [{
      data: [{{ available_seats }}, {{ booked_seats }}],
  backgroundColor: ['rgba(40, 167, 69, 0.8)', 'rgba(220, 53, 69, 0.8)'],
    borderColor: ['rgba(40, 167, 69, 1)', 'rgba(220, 53, 69, 1)'],
    borderWidth: 1
  }]
  };

  const seatAvailabilityConfig = {
    type: 'doughnut',
    data: seatAvailabilityData,
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'top', labels: { font: { size: 12 } } },
        tooltip: { backgroundColor: '#333', titleFont: { size: 14 }, bodyFont: { size: 12 } }
      }
    }
  };

  const seatAvailabilityChart = new Chart(document.getElementById('ChartTrafficSeats'), seatAvailabilityConfig);
</script>
{% endblock %}
{% endblock page_content %}

